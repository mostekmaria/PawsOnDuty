<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Michroma&display=swap" rel="stylesheet">
    <link rel="shortcut icon" href="static/logo.png"/>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/map.css') }}">
    <script src="{{ url_for('static', filename='js/mapscript.js') }}" alt=""></script>
</head>

<body>
    <div id="mySidebar" class="sidebar">
        <br><br>
        <br><br>
        <a href="#"><img id="title-PawsOnDuty" data-tooltip="Przejdź do strony głównej" src="static/logo-napis.png" width="auto" height="80"></a>
        <br><br>
        
        {% if not session.get('zalogowany') %}
        <a id="baroption" href="{{ url_for('register') }}">Zarejestruj się</a>
        <a id="baroption" href="{{ url_for('logowanie') }}">Zaloguj się</a>
        <a id="baroption" href="{{ url_for('chatbot') }}">Chatbot</a>
        {% else %}
        <a class="bar" id="barname">{{ session.get('name') }}</a>
        <br><br>
        <a id="baroption" href="{{ url_for('moje_zgloszenia') }}">Moje zgłoszenia</a>
        <a id="baroption" href="{{ url_for('wyloguj') }}">Wyloguj się</a>
        <a id="baroption" href="{{ url_for('chatbot') }}">Chatbot</a>
        {% endif %}
    </div>
    <header>
        <div id="logo">
            <a href="index.html"><img class="has-tooltip" data-tooltip="Przejdź do strony głównej" src="static/logo.png" width="90" height="90"></a><br>
        </div>
        <img id="menu" src="static/menu.png" onclick="openCloseNav()">
        <script src="{{ url_for('static', filename='js/sidebar.js') }}" alt=""></script>
        <div id="header">
            <a href="index.html"><img id="title-PawsOnDuty" data-tooltip="Przejdź do strony głównej" src="static/logo-napis.png" width="auto" height="65"></a><br>
        </div>
        <nav class="navbar navbar-dark bg-primary">
            {% if not zalogowany %}
            <a id="link1" class="has-tooltip" data-tooltip="Zarejestruj się" href=rejestracja.html>Zarejestruj się</a>
            <a id="link2" class="has-tooltip" data-tooltip="Zaloguj się" href=logowanie.html>Zaloguj się</a>
            {% else %}
            <span id="name">{{ imie }}</span>
            <a id="link2" class="has-tooltip" data-tooltip="Moje zgłoszenia" href="{{ url_for('moje_zgloszenia') }}">Moje zgłoszenia</a>   
            <a id="link1" class="has-tooltip" data-tooltip="Wyloguj się" href="{{ url_for('wyloguj') }}">Wyloguj się</a>
            {% endif %}
            <a id="link3" class="has-tooltip" data-tooltip="Chatbot" href="{{ url_for('chatbot') }}">Chatbot</a>
        </nav>  
    </header>  
    <main>
        <div class="chatbot">
            <div class="chatbot-title">
                <h1>Chatbot</h1>
                <p style="width:100%">Opowiedz swojemu osobistemu asystentowi, co się wydarzyło.</p>
            </div>
        
            <div class="chatbox">
                <div class="conversation">
                    {% for message in conversation %}
                        <p class="{{ 'user-message' if message.sender == 'user' else 'bot-message' }}">
                            <strong>{{ 'Ty:' if message.sender == 'user' else 'Chatbot:' }}</strong> {{ message.message }}
                        </p>
                    {% endfor %}
                </div>
            </div>
            
        
            {% if witness_step %}
                <p>Jeśli to możliwe, załącz zdjęcia ze zdarzenia:</p>
            {% endif %}
        
            <div class="message-field">
                {% if witness_step %}
                    <form id="photoForm" action="{{ url_for('chatbot') }}" method="post" enctype="multipart/form-data">
                        <div class="titleicon">
                            <span class="sb-title" id="sb-title">Zdjęcia z miejsca zdarzenia (jpg, png):</span>
                        </div>
                        <div class="file-upload-wrapper-chatbot">
                            <input type="file" class="full-input-photo" id="photo-chatbot" name="photo" accept=".jpg, .jpeg, .png">
                            <label for="photo-chatbot" class="custom-file-label" id="custom-file-label">Wybierz plik</label>
                            <span class="file-name">Nie wybrano pliku</span>
                        </div>
                        <button class="button" type="button" id="submit-photo-button">Prześlij zdjęcie</button>
                        <p id="email-request" class="bot-message" style="display:none;">
                            <strong>Chatbot:</strong> Jeśli chcesz otrzymać potwierdzenie przesłania zgłoszenia, podaj swój adres email.
                        </p>
                        <input id="user-email" type="email" name="email" class = "common-input-style" placeholder="Twój adres email" style="display:none;">
                        <button class="button" type="submit" style="display:none;" id="final-submit-button">Prześlij zgłoszenie</button>
                    </form>
                {% else %}
                    <form id="chatForm" action="{{ url_for('chatbot') }}" method="post">
                        <input id="message-user" type="text" name="user_input" class = "common-input-style" placeholder="Wpisz wiadomość">
                        <button class="send-sign" id="send" type="submit"></button>
                    </form>
                {% endif %}
            </div>            
        </div>        
    <main/>
    <script src="{{ url_for('static', filename='js/chat.js') }}"></script>
    <script>
        const zalogowany = "{{ 'true' if session.get('zalogowany') else 'false' }}" === 'true';
        
        const submitPhotoButton = document.getElementById('submit-photo-button');
        const submitLabel = document.getElementById('sb-title');
        const choosingPhotoButton = document.getElementById('custom-file-label');
        const userEmailInput = document.getElementById('user-email');
        const finalSubmitButton = document.getElementById('final-submit-button');
        const chatConversation = document.querySelector('.conversation');  // Pobieramy element rozmowy
        const photoInput = document.getElementById('photo-chatbot'); // Pobieramy pole do przesyłania zdjęć
        const photoForm = document.getElementById('photoForm'); // Pobieramy formularz do przesyłania zdjęć
    
        submitPhotoButton.addEventListener('click', function() {
            if (photoInput.files.length > 0) {
                const file = photoInput.files[0];
                const reader = new FileReader();

                reader.onload = function(e) {
                    // Tworzymy nowy element wiadomości od użytkownika
                    const userPhotoMessage = document.createElement('p');
                    userPhotoMessage.classList.add('user-message');
                    userPhotoMessage.innerHTML = `<strong>Ty:</strong> <img src="${e.target.result}" style="max-width: 200px; max-height: 200px;"/>`;
                    
                    // Dodajemy wiadomość do rozmowy
                    chatConversation.appendChild(userPhotoMessage);
                    // Scroll to bottom of conversation
                    chatConversation.scrollTop = chatConversation.scrollHeight;
                };

                reader.readAsDataURL(file);
                
                // Ukrywamy inne elementy po dodaniu zdjęcia
                photoInput.style.display = 'none';
                submitPhotoButton.style.display = 'none';
                submitLabel.style.display = 'none'; // Ukrywamy podpis do przesyłania
                choosingPhotoButton.style.display = 'none'; // Ukrywam przycisk do wybierania pliku

                // Wstawiamy wartość NULL dla zdjęć, jeśli nie ma przesłanych plików
                if (!photoInput.files.length) {
                    // Jeśli nie ma plików, to dodajemy do formularza ukryte pole z wartością NULL
                    let nullInput = document.createElement('input');
                    nullInput.type = 'hidden';
                    nullInput.name = 'photos';
                    nullInput.value = 'NULL'; // Przesyłamy wartość NULL
                    photoForm.appendChild(nullInput);
                }

                if (!zalogowany) {
                    // Tworzymy nowy element wiadomości od bota
                    const emailRequestMessage = document.createElement('p');
                    emailRequestMessage.classList.add('bot-message');  // Dodajemy klasę stylizującą wiadomość od chatbota
                    emailRequestMessage.innerHTML = "<strong>Chatbot:</strong> Aby uzyskać potwierdzenie przesłania zgłoszenia, podaj swój adres email.";
                    
                    // Dodajemy wiadomość do rozmowy
                    chatConversation.appendChild(emailRequestMessage);

                    // Wyświetlamy pole na e-mail i przycisk końcowy
                    userEmailInput.style.display = 'block';
                    finalSubmitButton.style.display = 'block';
                } else {
                    // Jeśli zalogowany, wysyłamy formularz
                    photoForm.submit();
                }
            }
        });
    </script>     
</body>

<footer>
    <p id="footer">Aplikacja webowa stworzona jako projekt pracy inżynierskiej AGH.</p>
    <p id="footer">© Maria Mostek, Patrycja Ruda. Kraków 2024.</p>
</footer>
</html>
